-- TABLAS PARA EL SISTEMA DE ENCOMIENDAS

--Crear tabla cliente
CREATE TABLE "cliente" (
  "id_cliente" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nombre" varchar(100),
  "email" varchar(120) UNIQUE,
  "telefono" varchar(20),
  "direccion" varchar(200)
);

--Crear tabla sucursal
CREATE TABLE "sucursal" (
  "id_sucursal" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nombre" varchar(100),
  "ciudad" varchar(50),
  "direccion" varchar(200)
);

--Crear tabla tarifa
CREATE TABLE "tarifa" (
  "id_tarifa" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "peso_min" numeric(6,2),
  "peso_max" numeric(6,2),
  "costo" numeric(12,2)
);

--Crear tabla encomienda
CREATE TABLE "encomienda" (
  "id_encomienda" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_cliente" int,
  "id_sucursal_origen" int,
  "id_sucursal_destino" int,
  "id_tarifa" int,
  "peso" numeric(6,2),
  "fecha_envio" date,
  "fecha_entrega" date,
  "estado" varchar(50)
);

--Crear tabla historial_estado
CREATE TABLE "historial_estado" (
  "id_historial" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_encomienda" int,
  "estado" varchar(50),
  "fecha" timestamp
);


-- Relaciones entre tablas
ALTER TABLE "encomienda" ADD FOREIGN KEY ("id_cliente") REFERENCES "cliente" ("id_cliente");

ALTER TABLE "encomienda" ADD FOREIGN KEY ("id_sucursal_origen") REFERENCES "sucursal" ("id_sucursal");

ALTER TABLE "encomienda" ADD FOREIGN KEY ("id_sucursal_destino") REFERENCES "sucursal" ("id_sucursal");

ALTER TABLE "encomienda" ADD FOREIGN KEY ("id_tarifa") REFERENCES "tarifa" ("id_tarifa");

ALTER TABLE "historial_estado" ADD FOREIGN KEY ("id_encomienda") REFERENCES "encomienda" ("id_encomienda");


-- INSERTAR DATOS --

--Insertar cliente 
INSERT INTO cliente (id_cliente, nombre, email, telefono, direccion) VALUES 
(1, 'Camila Rojas', 'camila.rojas@gmail.com', '987654321', 'Av. Alemania 123, Temuco'),
(2, 'Matías Fuentes', 'matias.fuentes@hotmail.com', '912345678', 'Av. Argentina 456, Valparaíso'),
(3, 'Valentina Soto', 'valentina.soto@gmail.com', '956789123', 'Av. Balmaceda 890, La Serena'),
(4, 'Diego Morales', 'diego.morales@gmail.com', '934567890', 'O’Higgins 234, Rancagua'),
(5, 'Francisca León', 'francisca.leon@yahoo.com', '978456123', 'Av. San Martín 321, Viña del Mar'),
(6, 'Sebastián Pérez', 'sebastian.perez@gmail.com', '965432178', 'Av. Pedro Aguirre Cerda 1500, Concepción'),
(7, 'Antonia Vega', 'antonia.vega@gmail.com', '943216789', 'Av. Ejército 890, Antofagasta'),
(8, 'Javier Contreras', 'javier.contreras@hotmail.com', '951234876', 'Av. España 2345, Punta Arenas');

SELECT * FROM cliente;

--Insertar sucursal
INSERT INTO sucursal (id_sucursal, nombre, ciudad, direccion) VALUES
(1, 'Sucursal Temuco', 'Temuco', 'Av. Alemania 123, Temuco'),
(2, 'Sucursal Valparaíso', 'Valparaíso', 'Av. Argentina 456, Valparaíso'),
(3, 'Sucursal La Serena', 'La Serena', 'Av. Balmaceda 890, La Serena'),
(4, 'Sucursal Rancagua', 'Rancagua', 'O’Higgins 234, Rancagua'),
(5, 'Sucursal Viña del Mar', 'Viña del Mar', 'Av. San Martín 321, Viña del Mar'),
(6, 'Sucursal Concepción', 'Concepción', 'Av. Pedro Aguirre Cerda 1500, Concepción'),
(7, 'Sucursal Antofagasta', 'Antofagasta', 'Av. Ejército 890, Antofagasta'),
(8, 'Sucursal Punta Arenas', 'Punta Arenas', 'Av. España 2345, Punta Arenas');

SELECT * FROM sucursal;

--Insertar tarifa
INSERT INTO tarifa (id_tarifa, peso_min, peso_max, costo) VALUES
(1, 0.00, 5.00, 5000.00),
(2, 5.01, 10.00, 8000.00),
(3, 10.01, 20.00, 12000.00),
(4, 20.01, 50.00, 20000.00),
(5, 50.01, 100.00, 35000.00);

SELECT * FROM tarifa;

--Insertar encomienda
INSERT INTO encomienda (id_encomienda, id_cliente, id_sucursal_origen, id_sucursal_destino, id_tarifa, peso, fecha_envio, fecha_entrega, estado) VALUES
(1, 1, 1, 2, 2, 7.50, '2024-06-01', '2024-06-05', 'En tránsito'),
(2, 2, 3, 4, 3, 15.00, '2024-06-02', '2024-06-07', 'En tránsito'),
(3, 3, 5, 6, 1, 3.00, '2024-06-03', '2024-06-04', 'Entregado'),
(4, 4, 7, 8, 5, 75.00, '2024-06-04', '2024-06-10', 'En tránsito'),
(5, 5, 2, 3, 4, 25.00, '2024-06-05', '2024-06-12', 'Entregado');

SELECT * FROM encomienda;

--Insertar historial_estado
INSERT INTO historial_estado (id_historial, id_encomienda, estado, fecha) VALUES
(1, 1, 'Enviado', '2024-06-01'),
(2, 1, 'En tránsito', '2024-06-03'),
(3, 2, 'Enviado', '2024-06-02'),
(4, 2, 'En tránsito', '2024-06-04'),
(5, 3, 'Enviado', '2024-06-03'),
(6, 3, 'Entregado', '2024-06-04'),
(7, 4, 'Enviado', '2024-06-04'),
(8, 4, 'En tránsito', '2024-06-06'),
(9, 5, 'Enviado', '2024-06-05'),
(10, 5, 'Entregado', '2024-06-12');

SELECT * FROM historial_estado;



-- CONSULTAS DE PRUEBA --


-- Consulta 1: Qué clientes han enviado encomiendas y desde qué sucursal a cuál? --
SELECT 
    c.nombre AS cliente,
    e.id_encomienda,
    so.nombre AS sucursal_origen,
    sd.nombre AS sucursal_destino,
    e.estado
FROM encomienda e
INNER JOIN cliente c 
    ON e.id_cliente = c.id_cliente
INNER JOIN sucursal so 
    ON e.id_sucursal_origen = so.id_sucursal
INNER JOIN sucursal sd 
    ON e.id_sucursal_destino = sd.id_sucursal;


-- Consulta 2: Obtener todas las encomiendas de un cliente específico
SELECT * FROM encomienda WHERE id_cliente = 1;