-- TABLAS PARA EL SISTEMA DE RETAIL

-- Crear tabla de clientes
CREATE TABLE "cliente" (
  "id_cliente" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nombre" varchar(100),
  "email" varchar(120) UNIQUE,
  "telefono" varchar(20),
  "direccion" varchar(200)
);

-- Crear tabla de categorías
CREATE TABLE "categoria" (
  "id_categoria" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nombre" varchar(100),
  "descripcion" varchar(200)
);

-- Crear tabla de productos
CREATE TABLE "producto" (
  "id_producto" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_categoria" int,
  "nombre" varchar(100),
  "descripcion" varchar(200),
  "precio" numeric(12,2),
  "stock" int
);

-- Crear tabla de pedidos
CREATE TABLE "pedido" (
  "id_cliente" int,
  "id_pedido" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "fecha" timestamp,
  "total" numeric(12,2),
  "estado" varchar(50)
);

-- Crear tabla de detalle de pedidos
CREATE TABLE "detalle_pedido" (
  "id_producto" int,
  "id_pedido" int,
  "cantidad" int,
  "precio_unitario" numeric(12,2),
  PRIMARY KEY ("id_producto", "id_pedido")
);

-- Crear tabla de pagos
CREATE TABLE "pago" (
  "id_pago" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_pedido" int,
  "fecha" timestamp,
  "monto" numeric(12,2),
  "metodo" varchar(50)
);


-- Establecer relaciones entre tablas
ALTER TABLE "producto" ADD FOREIGN KEY ("id_categoria") REFERENCES "categoria" ("id_categoria");

ALTER TABLE "pedido" ADD FOREIGN KEY ("id_cliente") REFERENCES "cliente" ("id_cliente");

ALTER TABLE "detalle_pedido" ADD FOREIGN KEY ("id_producto") REFERENCES "producto" ("id_producto");

ALTER TABLE "detalle_pedido" ADD FOREIGN KEY ("id_pedido") REFERENCES "pedido" ("id_pedido");

ALTER TABLE "pago" ADD FOREIGN KEY ("id_pedido") REFERENCES "pedido" ("id_pedido");


-- INSERTAR DATOS --

-- Insertar clientes --
INSERT INTO "cliente" (id_cliente,nombre, email, telefono, direccion) VALUES
(1, 'Sofía Martínez', 'sofia.martinez@gmail.com', '912345678', 'Av. Principal 123, Santiago'),
(2, 'Diego Fernández', 'diego.fernandez@gmail.com', '987654321', 'Av. Los Libertadores 456, Valparaíso'),
(3, 'Valentina Gómez', 'valentina.gomez@gmail.com', '956789123', 'Av. San Francisco 789, Concepción');

SELECT * FROM "cliente";

-- Insertar categorías --
INSERT INTO "categoria" (id_categoria, nombre, descripcion) VALUES
(1, 'Electrónica', 'Dispositivos electrónicos y gadgets'),
(2, 'Ropa', 'Prendas de vestir para todas las edades'),
(3, 'Hogar', 'Artículos para el hogar y decoración');   

SELECT * FROM "categoria";

-- Insertar productos --
INSERT INTO "producto" (id_producto, id_categoria, nombre, descripcion, precio, stock) VALUES
(1, 1, 'Smartphone XYZ', 'Smartphone de última generación con pantalla AMOLED', 305000, 50),
(2, 1, 'Laptop ABC', 'Laptop potente para trabajo y gaming', 950000, 30),
(3, 2, 'Camiseta Básica', 'Camiseta de algodón en varios colores', 19990, 200),
(4, 2, 'Jeans Clásicos', 'Jeans de corte clásico para hombre y mujer', 27990, 100),
(5, 3, 'Juego de Sábanas', 'Juego de sábanas de algodón para cama matrimonial', 59990, 80),
(6, 3, 'Lámpara de Mesa', 'Lámpara de mesa con diseño moderno y luz LED', 39990, 60);

SELECT * FROM "producto";

-- Insertar pedidos --
INSERT INTO "pedido" (id_cliente, id_pedido, fecha, total, estado) VALUES
(1, 1, '2026-01-15', 305000, 'En proceso'),
(2, 2, '2026-01-16', 479980, 'Enviado'),
(3, 3, '2026-01-17', 119980, 'Entregado');

SELECT * FROM "pedido";

-- Insertar detalle de pedidos --
INSERT INTO "detalle_pedido" (id_producto, id_pedido, cantidad, precio_unitario) VALUES
(1, 1, 1, 305000),
(3, 2, 2, 19990),
(4, 2, 1, 27990),
(5, 3, 1, 59990);

SELECT * FROM "detalle_pedido";

-- Insertar pagos --
INSERT INTO "pago" (id_pago, id_pedido, fecha, monto, metodo) VALUES
(1, 1, '2026-01-15', 305000, 'Tarjeta de Crédito'),
(2, 2, '2026-01-16', 479980, 'Transferencia Bancaria'),
(3, 3, '2026-01-17', 119980, 'Efectivo');

SELECT * FROM "pago";


-- CONSULTAS DE PRUEBA --

-- Consulta 1: Obtener el total de ventas por categoría --
SELECT c.nombre AS categoria, SUM(dp.cantidad * dp.precio_unitario) AS total_ventas
FROM "categoria" c
JOIN "producto" p ON c.id_categoria = p.id_categoria
JOIN "detalle_pedido" dp ON p.id_producto = dp.id_producto
GROUP BY c.nombre;

-- Consulta 2: Listar todos los pedidos de un cliente específico --
SELECT cl.nombre AS cliente, p.id_pedido, p.fecha, p.total, p.estado
FROM "cliente" cl
JOIN "pedido" p ON cl.id_cliente = p.id_cliente
WHERE cl.nombre = 'Sofía Martínez';